# .github/workflows/pullquest-auto-comment.yml
name: PullQuest ‚Äì comment on new issues

on:
  issues:
    types: [opened]

jobs:
  notify-pullquest:
    runs-on: ubuntu-latest

    # tie to your "production" environment so it can access its secrets
    environment: production

    permissions:
      issues: write

    env:
      PULLQUEST_BACKEND_URL: https://pullquestgithubbackend.onrender.com
      PULLQUEST_API_KEY:    "PullQuest-Testk9keu6"

    steps:
      - name: Show context
        run: |
          echo "üîç Repository: ${{ github.repository }}"
          echo "üîç Issue #:    ${{ github.event.issue.number }}"
          echo "üîç Labels:     ${{ toJson(github.event.issue.labels.*.name) }}"

      - name: Notify PullQuest backend
        id: notify
        run: |
          response=$(
            curl --silent --show-error \
              -X POST "$PULLQUEST_BACKEND_URL/api/comment/issues" \
              -H "Authorization: Bearer $PULLQUEST_API_KEY" \
              -H "Content-Type: application/json" \
              -d @- <<'JSON'
          {
            "github_token":  "${{ secrets.TOKEN_GITHUB }}",
            "repo":          "${{ github.repository }}",
            "issue_number":  ${{ github.event.issue.number }},
            "issue_url":     "${{ github.event.issue.html_url }}",
            "labels":        ${{ toJson(github.event.issue.labels.*.name) }}
          }
          JSON
          )
          echo "üõ∞Ô∏è  Backend response:"
          echo "$response"
          echo "::set-output name=response::$response"

      - name: Done
        run: |
          echo "‚úÖ PullQuest notified successfully"
          echo "üîÑ Response was: ${{ steps.notify.outputs.response }}"
