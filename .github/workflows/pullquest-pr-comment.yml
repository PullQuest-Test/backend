# .github/workflows/pullquest-pr-comment.yml
name: PullQuest ‚Äì comment on new PRs

on:
  pull_request:
    types: [opened]          # üëà only pull-requests

jobs:
  notify-pullquest:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write   # (issues: write is not required here)

    env:
      BACKEND_URL: https://pullquestgithubbackend.onrender.com

    steps:
      - name: Show context
        run: |
          echo "üîç Repo:   ${{ github.event.repository.full_name }}"
          echo "üîç Owner:  ${{ github.event.repository.owner.login }}"
          echo "üîç PR #:   ${{ github.event.pull_request.number }}"
          echo "üîç Labels: $(jq -r '.pull_request.labels | map(.name) | join(", ")' "$GITHUB_EVENT_PATH")"

      - name: Build payload & notify backend
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          LABELS=$(jq '.pull_request.labels | map(.name)' "$GITHUB_EVENT_PATH")

          payload=$(jq -n \
            --arg owner  "${{ github.event.repository.owner.login }}" \
            --arg repo   "${{ github.event.repository.name }}" \
            --argjson prNumber "$PR_NUMBER" \
            --argjson labels   "$LABELS" \
            '{owner:$owner, repo:$repo, prNumber:$prNumber, labels:$labels}')

          echo "üì¶ Payload:"
          echo "$payload"

          curl --silent --show-error \
               -X POST "$BACKEND_URL/api/comment/PullRequest" \
               -H "Content-Type: application/json" \
               --data-raw "$payload"

      - name: Done
        run: echo "‚úÖ PullQuest notified successfully"
