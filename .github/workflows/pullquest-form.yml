name: PullQuestAI XP Trigger

on:
  issue_comment:
    types: [created]

jobs:
  handle-xp-request:
    # Only run on pull request comments
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    
    steps:
    - name: Check if comment mentions @pullquestai and requests XP
      id: check-comment
      run: |
        comment_body="${{ github.event.comment.body }}"
        if [[ "$comment_body" == *"@pullquestai"* ]] && [[ "$comment_body" == *"give me the contributor xp for"* ]]; then
          echo "trigger_action=true" >> $GITHUB_OUTPUT
        else
          echo "trigger_action=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Post acknowledgment comment
      if: steps.check-comment.outputs.trigger_action == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PULLQUESTAI_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'Okay, providing in a minute! ðŸš€'
          })
    
    - name: Trigger XP calculation
      if: steps.check-comment.outputs.trigger_action == 'true'
      run: |
        echo "Triggering XP calculation for user: ${{ github.event.comment.user.login }}"
        echo "PR number: ${{ github.event.issue.number }}"
        echo "Comment: ${{ github.event.comment.body }}"
        
        # Add your XP calculation logic here
        # This could be:
        # - API call to your XP service
        # - Database update
        # - Calling another workflow
        # - Running a script
        
        # Example API call (uncomment and modify as needed):
        # curl -X POST "https://your-api-endpoint.com/calculate-xp" \
        #   -H "Content-Type: application/json" \
        #   -d '{
        #     "user": "${{ github.event.comment.user.login }}",
        #     "pr_number": "${{ github.event.issue.number }}",
        #     "repo": "${{ github.repository }}"
        #   }'
    
    - name: Post XP results (optional)
      if: steps.check-comment.outputs.trigger_action == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PULLQUESTAI_TOKEN }}
        script: |
          // Wait a minute as promised, then post results
          await new Promise(resolve => setTimeout(resolve, 60000));
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸŽ‰ XP calculation complete for @${{ github.event.comment.user.login }}!\n\n` +
                  `Here are your contributor XP details:\n` +
                  `- Pull Request: #${{ github.event.issue.number }}\n` +
                  `- XP Earned: [Your XP calculation results here]\n` +
                  `- Total XP: [User's total XP here]`
          })

# Optional: Add permissions if needed
permissions:
  issues: write
  pull-requests: write
  contents: read
