name: PullQuest â€“ serve form on demand

on:
  issue_comment:
    types: [created]          # fire for every new comment (issues & PRs)

jobs:
  respond_with_form:
    runs-on: ubuntu-latest
    permissions:
      issues: write           # PR comments are â€œissuesâ€ in the API

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£  Decide whether we really want to act
      #     (we run this step unconditionally so we can see the logs)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Should we reply?
        id: check
        run: |
          set -euo pipefail
          BODY_RAW='${{ github.event.comment.body }}'
          BODY_LOWER_TRIM=$(echo "$BODY_RAW" | tr '[:upper:]' '[:lower:]' | xargs)

          echo "Raw body      : [$BODY_RAW]"
          echo "Processed body: [$BODY_LOWER_TRIM]"

          # Condition âœ must be on a PR **and** start with @pullquestai form
          if [[ -n "${{ github.event.issue.pull_request }}" && \
                "$BODY_LOWER_TRIM" == @pullquestai\ form* ]]; then
            echo "reply=yes" >>"$GITHUB_OUTPUT"
            echo "âœ… Condition matched â€“ will post form"
          else
            echo "reply=no"  >>"$GITHUB_OUTPUT"
            echo "âŒ Not a match â€“ nothing to do"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2ï¸âƒ£  Post the form comment, *only* if step 1 said so
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post PullQuest form
        if: steps.check.outputs.reply == 'yes'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### ğŸ“ PullQuest AI Form  
            Hi @${{ github.event.comment.user.login }} â€“ please fill this out:

            | Field | Details |
            |-------|---------|
            | **Context** | *What does this PR do?* |
            | **Areas of concern** | *Specific files or behaviours to focus on?* |
            | **Preferred review style** | *Quick issues*, *deep dive*, *performance tips*, â€¦ |

            When ready, comment **`@pullquestai review`** to trigger an AI review ğŸš€.
